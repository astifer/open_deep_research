# Отчёт по безопасности Open Deep Research (LLM / Tooling / Prompt Security)

> Видео отчет доступен по ссылке https://cloud.mail.ru/public/MTit/59yUL2Q6X или https://drive.google.com/file/d/1V4LDSkUWeZ1QePdcqFdrmYEhd-96J1VZ/view?usp=sharing
## Резюме

В рамках работы проведён точечный аудит и усиление безопасности сервиса Open Deep Research в контексте использования внутри крупной консалтинговой компании (мультиагентный ресёрч по открытым источникам).

Основные изменения:
- Исправлено описание блока **Available Tools**: ранее модели интерпретировали доступные инструменты некорректно (ощущение “доступно только 2 тула”), что приводило к ошибочным действиям и галлюцинациям. Изменения внесены в `src/open_deep_research/prompts.py`.
- В промпт ресёрчера добавлен маркер **UNTRUSTED CONTENT** для явного снижения доверия к входным данным/сообщениям и контенту из внешних источников. Это снижает риск отравления данных и злоупотребления инструкциями в контексте. Изменения внесены в `src/open_deep_research/prompts.py`.
- Реализован механизм проверки источников, которые система пытается использовать/извлечь (детали зафиксированы в видео-отчёте).  
- Закрыт критичный риск: пользователь мог добиваться обращения к конфиденциальным источникам (в т.ч. попытки извлечения API-ключа). Добавлена валидация вызовов инструментов; подход сделан конфигурируемым, добавлен новый конфиг для упрощения разработки и повышения гибкости.

Артефакты подтверждений:
- Скриншот галлюцинаций / неверных источников: `imgs/hall.png`
- Скриншот сценария деградации/DoS: `imgs/dos.png`

---

## Контекст использования и границы ответственности

**Контекст:** внутренняя система ресёрча в консалтинге, где агенты автоматически собирают данные из открытых источников (новости, статьи, отчёты конкурентов) и формируют аналитические ответы.

**Угрозы, которые приоритетны именно в таком контексте:**
- компрометация достоверности отчётов (ложные ссылки/цитаты, “не те” источники);
- деградация производительности (длинные цепочки рассуждений, чрезмерная нагрузка/зависания);
- утечки и злоупотребление доступом к конфиденциальным данным/секретам через инструменты.

---

## Модель угроз

### Таблица: активы → угрозы → векторы → сценарии воздействия

| Актив | Угроза | Вектор атаки | Сценарий воздействия | Текущие меры защиты (внесённые изменения) |
|---|---|---|---|---|
| Достоверность итогового отчёта и цитирований | Галлюцинации / цитирование “чужих” источников | Некорректное использование/выбор инструментов, отсутствие использования целевых MCP tools | Модель выдаёт ссылки/утверждения не из целевых источников; снижение доверия к результатам | Исправление `Available Tools` описания (снижение путаницы у модели) |
| Контекст/сообщения в промпте (messages) и внешний контент | Prompt Injection / отравление данных (model over-trust) | Внешний контент/сообщения в контексте воспринимаются как “инструкция” | Злоумышленник подмешивает директивы; модель выполняет нецелевые действия или формирует неправильный вывод | Добавлен маркер `UNTRUSTED CONTENT` в промпт ресёрчера |
| Ресурсы исполнения (время/лимиты) | DoS через “слишком длинное выполнение” | Инструкция типа “думай больше/дольше”, провокация на чрезмерно длинную цепочку выполнения | Сильно растёт время ответа/количество шагов, сервис деградирует | `UNTRUSTED CONTENT` (снижает влияние подобных сообщений) Влияние в процентах не изучено)) |
| Конфиденциальные источники/секреты (включая API ключи) | Экфильтрация секретов / несанкционированный доступ | Принуждение модели вызвать инструменты с доступом к секретам / попытки достать ключи | Возможна компрометация API ключа и дальнейшее злоупотребление | Валидация использования инструментов + конфигурируемый allow/deny-list (новый конфиг) |
| Канал получения источников | Подмена/использование нерелевантных источников | Модель выбирает неподходящий URL/источник | Репорт формируется на базе низкокачественного/нерелевантного контента | Система проверки источников (подробности в видео-отчёте) |


---

##  Анализ исходного кода (baseline)

###  Методология анализа
Бейзлайн анализировался через:
1) **Статический просмотр** промптов и описаний инструментов (в особенности блок `Available Tools`) в `src/open_deep_research/prompts.py`.
2) **Набор целевых негативных сценариев** (инъекции в контекст, провокация на чрезмерное выполнение, попытки доступа к конфиденциальным источникам).
3) **Фиксация поведения** через артефакты (скриншоты/логи), включая всё в `imgs/*` 

###  Найденные уязвимости (baseline) и оценка критичности

| ID | Уязвимость | Описание | Наблюдаемое проявление | OWASP код(ы) |Критичность (оценка) | Артефакт |
|---|---|---|---|---|---|---|
| V1 | Путаница в доступных инструментах | Модель “думает”, что доступно меньше инструментов, чем есть, и действует неверно | Галлюцинации и цитирование других источников вместо целевых MCP tools | LLM09:2025 Misinformation, LLM05:2025 Improper Output Handling |Средняя | `imgs/hall.png` |
| V2 | Чрезмерное доверие к messages/контенту | Контекст воспринимается как доверенный; возможны инъекции и управление ходом выполнения | Удлинение исполнения по провокации (“think more”) вплоть до деградации (DoS) | LLM01:2025 Prompt Injection, LLM10:2025 Unbounded Consumption | Высокая | `imgs/dos.png` |
| V3 | Доступ к конфиденциальным источникам/секретам | Пользователь может склонить систему к обращению к конфиденциальным источникам и попыткам извлечения ключей | Риск компрометации API ключа | LLM02:2025 Sensitive Information Disclosure LLM06:2025 Excessive Agency | Критическая | скринкаст |

---

## Proof of Concept (PoC) по ключевым уязвимостям

### PoC для V1 — Путаница в инструментах / неправильные источники

**Цель атаки:** добиться неправильных ссылок/цитирования нецелевых источников, снизить достоверность отчёта.

**Метод / промпт:**  
-  Просим агента подготовить отчет о компании, не уточняя многие детали.

**Реакция бейзлайна:**  
- Наблюдались галлюцинации и цитирование других источников при неиспользовании целевых MCP tools.  
- Подтверждение: `imgs/hall.png`.

**Вектор смягчения:**  
- Исправить описание `Available Tools`, чтобы модель корректно понимала доступные инструменты и выбирала правильные.

**Реализация исправления:**  
- Изменения в `src/open_deep_research/prompts.py` (коррекция текста `Available Tools`).

---

### PoC для V2 — Prompt injection / DoS через “think more”

**Цель атаки:** спровоцировать длительное выполнение (рост шагов/времени), вплоть до деградации сервиса.

**Метод / промпт:**  
- В сообщениях/контексте размещается инструкция, влияющая на поведение (“используй think больше”), что приводит к чрезмерно долгому выполнению.  

**Реакция бейзлайна:**  
- “Очень долгое исполнение команды”, интерпретируемое как DoS-эффект.  
- Подтверждение: `imgs/dos.png`.

**Вектор смягчения:**  
- Явно маркировать сообщения и внешние данные как недоверенные, чтобы модель не воспринимала их как обязательные директивы.

**Реализация исправления:**  
- Добавлен маркер `UNTRUSTED CONTENT` в промпт ресёрчера (`src/open_deep_research/prompts.py`).

---

### PoC для V3 — Доступ к конфиденциальным источникам / попытка извлечения API ключа

**Цель атаки:** добиться вызова инструмента/источника, который раскрывает секреты (например, API ключ), либо получить доступ к конфиденциальным данным.

**Метод / промпт:**  
- на экране есть)

**Реакция бейзлайна:**  
- Риск: “пользователь мог добиться получения API ключа”.  
- Подтверждение: явное видео

**Вектор смягчения:**  
- Ввести обязательную валидацию использования инструментов (policy enforcement), запретить/ограничить обращения к конфиденциальным источникам.

**Реализация исправления:**  
- Добавлена валидация на использование инструментов.  
- Подход сделан конфигурируемым; добавлен новый конфиг для упрощения разработки и повышения гибкости. В diff видно исправление в configuration, deep_researcher и utils.
